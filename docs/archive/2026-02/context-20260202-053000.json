{
  "request_id": "dev-20260202-053000",
  "timestamp": "2026-02-02T05:30:00Z",
  "requirement": {
    "original": "系统性修复 - push到graph应该和generate graph的脚本放到一起，这两个一个脚本，不分开，只要生成一定发布。另外plan command还出现了一堆自己写脚本，脚本错误的情况，列举出现的全部状况并告诉我修复计划",
    "clarified": "系统性修复/plan命令的6个核心问题：1)脚本分离导致workflow中断 2)AI临时创建不标准脚本 3)Budget JSON生成错误 4)Workflow步骤跳过 5)文件命名不一致 6)部署脚本验证过严",
    "what": "全量修复travel planner的脚本架构、agent代码、workflow强化、命名标准化",
    "why": "防止AI跳步、确保生成即部署、消除临时脚本、提高系统可靠性",
    "where": [
      "scripts/generate-travel-html.sh",
      "scripts/deploy-travel-plans.sh",
      "scripts/generate-bucket-list-html.sh (to be removed)",
      ".claude/commands/plan.md",
      ".claude/agents/ (budget agent)",
      "scripts/lib/ (new Python module)"
    ],
    "scope": {
      "included": [
        "P0: 合并生成和部署脚本为原子操作",
        "P0: 强化workflow文档防止跳步",
        "P1: 修复budget agent的JSON生成bug",
        "P1: 统一文件命名规范",
        "P2: 创建可复用Python模块",
        "P2: 创建workflow验证机制",
        "P3: 更新文档和测试"
      ],
      "excluded": [
        "修改已发布的travel plan HTML",
        "重构整个travel-planner架构",
        "修改其他commands（只关注/plan）"
      ]
    },
    "success_criteria": [
      "原子性：生成HTML立即部署，不可分离",
      "无跳步：AI必须执行完整workflow，TodoWrite强制跟踪",
      "无错误：所有agent生成的JSON都经过validation",
      "标准化：统一的命名规范和脚本接口",
      "可复用：Python模块化，消除临时脚本",
      "可测试：端到端测试通过itinerary和bucket list两种场景"
    ],
    "constraints": [
      "保持向后兼容：已有travel plans不受影响",
      "不破坏GitHub Pages：部署仓库travel-planner-graph保持稳定",
      "遵循项目规范：参数化脚本、source venv、有意义命名",
      "最小化复杂度：优先简单方案，避免过度工程"
    ]
  },
  "root_cause_analysis": {
    "symptom": "用户执行/plan命令后需要手动/dev来部署，AI创建了临时脚本且有JSON错误",
    "root_cause": "脚本分离设计 + workflow步骤标记为Optional + 缺少强制验证机制 + agent代码有JSON生成bug",
    "root_cause_commit": "原始设计问题，非单一commit导致",
    "why_introduced": "原始设计认为部署是可选的（用户可能只想本地查看），未考虑到AI执行时容易跳步",
    "why_problematic": "AI没有强制约束会主观判断跳过步骤，临时脚本难以维护且违反标准",
    "timeline": "问题在2026-02-02执行/plan china exchange bucket list时暴露",
    "affected_files": [
      "scripts/generate-travel-html.sh (needs merge)",
      "scripts/deploy-travel-plans.sh (needs merge)",
      "scripts/generate-bucket-list-html.sh (needs removal)",
      ".claude/commands/plan.md (needs workflow enforcement)",
      "budget agent code (needs JSON validation)"
    ]
  },
  "context": {
    "codebase_state": "11 uncommitted changes in data/ and scripts/",
    "recent_commits": [
      "f2f5c8b - checkpoint: Auto-save at 2026-02-02 05:34:55",
      "2404a5d - checkpoint: Auto-save at 2026-02-02 00:07:13",
      "edac170 - checkpoint: Auto-save at 2026-02-01 23:54:52"
    ],
    "file_contents": {
      "scripts/generate-travel-html.sh": "12688 bytes, generates standard itinerary HTML",
      "scripts/deploy-travel-plans.sh": "18992 bytes, deploys to GitHub Pages with strict filename validation",
      "scripts/generate-bucket-list-html.sh": "25224 bytes, custom script with embedded Python (828 lines), hardcoded output path",
      ".claude/commands/plan.md": "Contains workflow with 'Optional Deployment' at Step 18"
    },
    "dependencies": {
      "runtime": "Bash 5.x, Python 3.12",
      "packages": "jq (for JSON processing)",
      "external": "GitHub Pages (travel-planner-graph repo), SSH keys for git push"
    },
    "environment": {
      "venv_path": "/root/.claude/venv",
      "project_root": "/root/travel-planner",
      "git_state": "On branch master, 11 uncommitted files"
    }
  },
  "development_approach": {
    "strategy": "按优先级顺序执行5个阶段，每个阶段完成后验证",
    "phases": [
      {
        "phase": "P0 - 脚本合并与workflow强化",
        "tasks": [
          "创建 scripts/generate-and-deploy.sh (合并生成+部署)",
          "支持自动检测项目类型 (itinerary vs bucket list)",
          "修改 .claude/commands/plan.md (Step 16-18改为强制)",
          "删除 scripts/generate-bucket-list-html.sh"
        ]
      },
      {
        "phase": "P1 - Agent修复与命名标准化",
        "tasks": [
          "定位并修复budget agent的JSON生成bug",
          "添加JSON validation到agent代码",
          "统一输出文件命名：travel-plan-{destination}-{date}.html",
          "更新部署脚本支持bucket list命名"
        ]
      },
      {
        "phase": "P2 - Python模块化与验证机制",
        "tasks": [
          "创建 scripts/lib/html_generator.py (可复用模块)",
          "创建 scripts/validate-plan-workflow.sh (验证脚本)",
          "添加TodoWrite强制更新检查"
        ]
      },
      {
        "phase": "P3 - 文档与测试",
        "tasks": [
          "更新 scripts/README.md",
          "创建测试用例 (itinerary + bucket list)",
          "端到端验证"
        ]
      }
    ],
    "scripts_to_create": [
      "scripts/generate-and-deploy.sh (P0, 原子操作脚本)",
      "scripts/lib/html_generator.py (P2, Python模块)",
      "scripts/validate-plan-workflow.sh (P2, 验证脚本)",
      "scripts/tests/test-plan-workflow.sh (P3, 测试脚本)"
    ],
    "files_to_modify": [
      ".claude/commands/plan.md (强化workflow)",
      "scripts/deploy-travel-plans.sh (放宽命名验证，或集成到新脚本)",
      "scripts/generate-travel-html.sh (标记deprecated或集成到新脚本)"
    ],
    "files_to_delete": [
      "scripts/generate-bucket-list-html.sh (临时脚本)"
    ],
    "validation_approach": "每个阶段完成后运行验证脚本，最终进行端到端测试"
  },
  "standards_to_enforce": {
    "no_hardcoded_values": true,
    "use_source_venv": true,
    "integer_step_numbering": true,
    "meaningful_naming": true,
    "git_root_cause_reference": true,
    "atomic_operations": true,
    "json_validation": true,
    "workflow_enforcement": true
  },
  "quality_gates": {
    "P0_completion": {
      "criteria": [
        "generate-and-deploy.sh可执行且通过基本测试",
        "plan.md中Step 16-18标记为强制",
        "generate-bucket-list.sh已删除"
      ]
    },
    "P1_completion": {
      "criteria": [
        "budget agent不再生成JSON错误",
        "文件命名统一且部署脚本接受两种格式"
      ]
    },
    "P2_completion": {
      "criteria": [
        "Python模块可导入且工作正常",
        "validate-plan-workflow.sh能检测跳步"
      ]
    },
    "P3_completion": {
      "criteria": [
        "文档更新完整",
        "测试用例全部通过"
      ]
    }
  }
}
