{
  "request_id": "dev-20260212-175337",
  "timestamp": "2026-02-12T17:53:37Z",
  "requirement": {
    "original": "Fix all 9 remaining hardcoded validation issues in scripts/plan-validate.py to make validation schema-driven and configuration-based instead of hardcoded",
    "clarified": "Refactor scripts/plan-validate.py to eliminate 9 hardcoded validation patterns by moving hardcoded values to configuration structures (dictionaries, config files, or schema-driven approaches). Make validation logic flexible and maintainable.",
    "what": "Replace hardcoded validation logic with configuration-based validation",
    "why": "Current hardcoded approach causes false positives (like restaurant transit names), is inflexible for different projects/regions, and violates DRY principles. Configuration-based validation is maintainable and extensible.",
    "where": [
      "scripts/plan-validate.py"
    ],
    "scope": {
      "included": [
        "Fix 1: English placeholders (line 64) - move to config",
        "Fix 2: Currency-region mapping (line 55) - move to config file or infer from data",
        "Fix 3: Base/local pair enforcement (line 645) - schema-driven",
        "Fix 4: Intentional overlap keywords (line 591) - move to config",
        "Fix 5: Budget category hardcoding (lines 620, 630) - schema-driven from budget schema",
        "Fix 6: Title case enforcement (line 571) - make configurable",
        "Fix 7: Invalid transport types (line 136) - already uses VALID_TRANSPORT_TYPES constant, validate it's schema-driven",
        "Fix 8: AGENTS_WITH_LOCAL whitelist (line 67) - infer from schema or config",
        "Fix 9: Trip label hardcoding (line 1015) - make dynamic or remove"
      ],
      "excluded": [
        "Changing validation schemas themselves",
        "Modifying agent data files",
        "Changing HTML generation logic"
      ]
    },
    "success_criteria": [
      "All 9 hardcoded patterns eliminated or moved to configuration",
      "Validation script runs successfully on existing data without new false positives",
      "Configuration is documented and easy to modify",
      "No hardcoded city names, currency codes, or keyword lists in validation logic",
      "Validation logic references schemas where possible instead of hardcoding rules",
      "Zero HIGH severity false positives on test data"
    ],
    "constraints": [
      "Must maintain backward compatibility with existing data",
      "Must not break existing validation that correctly catches real issues",
      "Configuration must be easily maintainable by non-developers",
      "Performance must not degrade significantly"
    ]
  },
  "root_cause_analysis": {
    "symptom": "Hardcoded validation logic causes false positives (e.g., 'Walk to Restaurant' flagged as meal) and requires code changes for new regions/currencies",
    "root_cause": "plan-validate.py was created (commit f0cc710, 2026-02-10) with hardcoded constants for quick implementation. The script embedded domain knowledge (city-currency mappings, keyword lists) directly in code instead of extracting from schemas or configuration.",
    "root_cause_commit": "f0cc710 - checkpoint: Auto-save at 2026-02-10 18:31:24 (initial creation)",
    "why_introduced": "Initial implementation prioritized working validation over flexible architecture. Hardcoded values were expedient for single-use case (China trip validation).",
    "why_problematic": "Hardcoded approach doesn't scale: (1) false positives like restaurant transit names, (2) requires code changes for new regions, (3) duplicates schema information, (4) violates DRY principle",
    "timeline": "Created 2026-02-10, first fix for false positive 2026-02-12 (commit 2e14cfa removed meal keyword check)",
    "affected_files": [
      "scripts/plan-validate.py"
    ],
    "previous_fix": "Commit 2e14cfa removed hardcoded meal keyword validation (line 529) that caused false positives - this is the pattern we need to apply to remaining 9 issues"
  },
  "context": {
    "codebase_state": "M .claude/settings.json\n?? docs/dev/completion-20260212-162955.md\n?? docs/dev/qa-report-iter2-20260212-162955.json",
    "recent_commits": [
      "2e14cfa fix: Remove hardcoded meal keyword validation causing false positives in travel_segments",
      "a790e72 checkpoint: Auto-save at 2026-02-12 16:30:30",
      "ac963d8 feat: Add 'name' to legacy field map for validation"
    ],
    "file_contents": {
      "scripts/plan-validate.py": "See lines 55-67 (hardcoded constants), 136-140 (transport types), 571-576 (currency check), 591-603 (overlap keywords), 620-630 (budget categories), 645-659 (base/local pair), 1015-1017 (trip label)"
    },
    "dependencies": {
      "runtime": "Python 3.x",
      "packages": "json, jsonschema (for schema validation)"
    },
    "environment": {
      "venv_path": "venv/",
      "schemas_dir": "schemas/",
      "data_dir": "data/"
    },
    "schemas_available": [
      "schemas/meals.json",
      "schemas/attractions.json",
      "schemas/entertainment.json",
      "schemas/accommodation.json",
      "schemas/shopping.json",
      "schemas/transportation.json",
      "schemas/budget.json",
      "schemas/timeline.json"
    ]
  },
  "development_approach": {
    "strategy": "Move hardcoded values to configuration structures and schema-driven inference. Pattern: (1) Extract hardcoded constants to top-level CONFIG dict, (2) Infer validation rules from schemas where possible, (3) Document configuration clearly.",
    "priority_order": [
      "HIGH: Currency-region (line 55) - move to config or remove if not essential",
      "HIGH: AGENTS_WITH_LOCAL (line 67) - infer from schemas",
      "HIGH: Base/local pair (line 645) - already schema-driven, verify correctness",
      "MEDIUM: English placeholders (line 64) - move to CONFIG",
      "MEDIUM: Intentional overlap keywords (line 591) - move to CONFIG",
      "MEDIUM: Budget categories (lines 620, 630) - extract from budget schema",
      "MEDIUM: Title case (line 571) - make configurable or remove",
      "LOW: Invalid transport types (line 136) - verify it's schema-driven",
      "LOW: Trip label (line 1015) - remove or make dynamic"
    ],
    "scripts_to_create": [],
    "files_to_modify": [
      "scripts/plan-validate.py"
    ],
    "validation_approach": "Run plan-validate.py on test data (china-feb-15-mar-7-2026-20260202-195429) before and after changes. Ensure: (1) No new false positives, (2) No regressions (existing issues still caught), (3) All 9 hardcoded patterns eliminated"
  },
  "standards_to_enforce": {
    "no_hardcoded_values": true,
    "use_source_venv": true,
    "integer_step_numbering": false,
    "meaningful_naming": true,
    "git_root_cause_reference": true,
    "documentation": "Add CONFIG section comment explaining each configuration option"
  },
  "detailed_issues": [
    {
      "id": 1,
      "line": 64,
      "severity": "MEDIUM-HIGH",
      "issue": "ENGLISH_PLACEHOLDERS = ['Optional', 'Alternative', 'TBD', 'N/A', 'None', 'Item ']",
      "problem": "Hardcoded list, may need adjustment for different projects",
      "fix": "Move to CONFIG dict at top with clear documentation"
    },
    {
      "id": 2,
      "line": 55,
      "severity": "MEDIUM-HIGH",
      "issue": "CURRENCY_REGION dict with 19 hardcoded city-currency mappings",
      "problem": "Requires code changes for new regions, duplicates data that could be in trip metadata",
      "fix": "Move to external config file (e.g., config/currency-region-map.json) OR remove check if trip metadata already has this info"
    },
    {
      "id": 3,
      "line": 645,
      "severity": "MEDIUM-HIGH",
      "issue": "Base/local pair consistency enforcement",
      "problem": "Logic checks if _base has content then _local must exist - this is actually schema-driven and correct, verify it works as intended",
      "fix": "Review logic, add comments explaining schema requirement, no code change likely needed"
    },
    {
      "id": 4,
      "line": 591,
      "severity": "MEDIUM",
      "issue": "intentional_kw = ['optional', 'alternative', ' or ', 'in-park']",
      "problem": "Hardcoded keywords for timeline overlap detection",
      "fix": "Move to CONFIG dict with clear documentation"
    },
    {
      "id": 5,
      "lines": [
        620,
        630
      ],
      "severity": "MEDIUM",
      "issue": "cats = ['meals', 'accommodation', 'activities', 'shopping', 'transportation']",
      "problem": "Budget categories hardcoded instead of reading from budget schema",
      "fix": "Extract categories from schemas/budget.json $defs/budget_categories/properties"
    },
    {
      "id": 6,
      "line": 571,
      "severity": "MEDIUM",
      "issue": "Title case enforcement on type_base field",
      "problem": "Hardcoded assumption that type_base should be Title Case",
      "fix": "Make configurable via CONFIG['enforce_title_case'] = True, or remove check if not essential"
    },
    {
      "id": 7,
      "line": 136,
      "severity": "MEDIUM",
      "issue": "INVALID_TRANSPORT_TYPES = {'meal', 'breakfast', ...}",
      "problem": "Hardcoded list, though VALID_TRANSPORT_TYPES is already correct",
      "fix": "Verify VALID_TRANSPORT_TYPES comes from schema, remove INVALID_TRANSPORT_TYPES if redundant"
    },
    {
      "id": 8,
      "line": 67,
      "severity": "MEDIUM",
      "issue": "AGENTS_WITH_LOCAL = {'meals', 'attractions', 'entertainment', 'accommodation', 'shopping'}",
      "problem": "Hardcoded whitelist instead of inferring from schemas",
      "fix": "Infer by checking if schema $defs/<agent>_item has name_local in required fields"
    },
    {
      "id": 9,
      "line": 1015,
      "severity": "LOW",
      "issue": "if 'china-feb' in trip.lower(): return 'itinerary'",
      "problem": "Hardcoded trip-specific logic",
      "fix": "Remove special-casing or make trip label configurable in trip metadata"
    }
  ],
  "dev": {
    "status": "completed",
    "tasks_completed": [
      {
        "id": 1,
        "description": "Created CONFIG dictionary with all configurable validation settings",
        "type": "refactor",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Added CONFIG dictionary (lines 46-82) with 4 configurable settings: english_placeholders, currency_region_map (disabled), intentional_overlap_keywords, enforce_title_case. Added comprehensive documentation explaining each option.",
        "rationale": "Root cause: Commit f0cc710 hardcoded validation logic. Fix pattern from commit 2e14cfa: move hardcoded values to configuration. Addresses Fix 1, 2, 4, 6."
      },
      {
        "id": 2,
        "description": "Implemented schema-driven AGENTS_WITH_LOCAL inference",
        "type": "refactor",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Added _init_schema_driven_config() method to SchemaRegistry (lines 207-240). Populates AGENTS_WITH_LOCAL by checking each agent schema for name_local in properties. Eliminates hardcoded whitelist.",
        "rationale": "Fix 8: Instead of hardcoding {meals, attractions, entertainment, accommodation, shopping}, now infers from schemas. Makes validation adapt automatically if new agents are added."
      },
      {
        "id": 3,
        "description": "Implemented schema-driven budget category extraction",
        "type": "refactor",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Added get_budget_categories() method to SchemaRegistry (lines 267-282). Extracts category names from budget.schema.json $defs/budget_categories/properties. Updated budget validation (line 746) to use registry.get_budget_categories() instead of hardcoded list.",
        "rationale": "Fix 5: Eliminates hardcoded budget categories [meals, accommodation, activities, shopping, transportation]. Now reads from schema, ensuring validation stays in sync with schema changes."
      },
      {
        "id": 4,
        "description": "Implemented schema-driven transport type validation",
        "type": "refactor",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Added transport type extraction in _init_schema_driven_config() (lines 233-254). Extracts valid types from timeline.schema.json travel_segment.type_base description using regex. Populates VALID_TRANSPORT_TYPES at runtime instead of hardcoding.",
        "rationale": "Fix 7: Previously hardcoded {walk, taxi, metro, bus, train, car, ferry}. Now extracts from schema description. Discovered new type 'transit' in validation output that wasn't in hardcoded list."
      },
      {
        "id": 5,
        "description": "Updated semantic validation to use CONFIG values",
        "type": "refactor",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Updated check_semantics() function: (1) English placeholders now uses CONFIG.get('english_placeholders') (line 668), (2) Title case enforcement now uses CONFIG.get('enforce_title_case', True) (line 680), (3) Currency-region validation now uses CONFIG.get('currency_region_map', {}) and is disabled by default (lines 690-699), (4) Intentional overlap keywords now uses CONFIG.get('intentional_overlap_keywords') (line 705).",
        "rationale": "Implements Fix 1, 2, 4, 6 by replacing hardcoded values with configuration lookups. Makes validation behavior customizable without code changes."
      },
      {
        "id": 6,
        "description": "Removed hardcoded trip label patterns",
        "type": "refactor",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Updated _trip_label() function (lines 1140-1149) to remove hardcoded pattern 'china-feb' -> 'itinerary'. Added documentation explaining trip labels should come from metadata, not hardcoded patterns.",
        "rationale": "Fix 9: Eliminates trip-specific hardcoding. Only keeps generic 'bucket' pattern for bucket-list trips."
      },
      {
        "id": 7,
        "description": "Fixed budget validation TypeError with type checking",
        "type": "bugfix",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Added type checking in budget sum validation (lines 746-765) and cross-agent budget comparison (lines 894-895) to handle cases where budget values might be dicts instead of numbers. Prevents TypeError during validation.",
        "rationale": "Discovered during testing: some budget data had dict values instead of numbers. Added defensive type checking to prevent crashes."
      },
      {
        "id": 8,
        "description": "Added registry parameter to check_semantics signature",
        "type": "refactor",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Updated check_semantics() function signature to accept registry parameter (line 664). Updated all call sites in run_pipeline() (lines 967, 981) to pass registry.",
        "rationale": "Necessary for Fix 5 (budget categories) to access registry.get_budget_categories() within semantic checks."
      },
      {
        "id": 9,
        "description": "Documented configuration guide in code comments",
        "type": "documentation",
        "files_modified": [
          "scripts/plan-validate.py"
        ],
        "changes": "Added comprehensive CONFIG documentation (lines 46-64) explaining: purpose of each setting, default values, when to enable/disable, and impact on validation behavior.",
        "rationale": "Makes configuration easily maintainable by non-developers, per success criteria: 'Configuration must be documented and easy to modify'."
      }
    ],
    "scripts_created": [],
    "files_modified": [
      {
        "path": "scripts/plan-validate.py",
        "purpose": "Refactored hardcoded validation logic to configuration-based and schema-driven approach",
        "changes_summary": "Eliminated 9 hardcoded patterns by: (1) Creating CONFIG dict for 4 configurable settings, (2) Inferring AGENTS_WITH_LOCAL from schemas, (3) Extracting budget categories from schema, (4) Extracting transport types from schema, (5) Removing trip-specific label hardcoding"
      }
    ],
    "git_rationale": {
      "root_cause_commit": "f0cc710 - checkpoint: Auto-save at 2026-02-10 18:31:24 (initial plan-validate.py creation)",
      "why_issue_occurred": "Initial implementation prioritized working validation over flexible architecture. Hardcoded constants (city-currency mappings, keyword lists, agent whitelists) were expedient for single-use case (China trip validation) but don't scale to multiple regions/projects.",
      "how_fix_addresses_root": "Applies fix pattern from commit 2e14cfa (removed hardcoded meal keywords) to remaining 9 issues. Moves hardcoded values to: (1) CONFIG dictionary for easy modification, (2) Schema-driven inference for values that can be derived from schemas, (3) Documentation for maintainability. Now supports multiple regions/projects without code changes."
    },
    "validation_results": {
      "before": "Validation script crashed with TypeError: unsupported operand type(s) for +: 'int' and 'dict' at line 625 when trying to sum budget categories. Hardcoded validation logic included:\n- Line 55: CURRENCY_REGION dict with 19 hardcoded city mappings\n- Line 64: ENGLISH_PLACEHOLDERS hardcoded list\n- Line 67: AGENTS_WITH_LOCAL hardcoded set\n- Line 136: INVALID_TRANSPORT_TYPES hardcoded set\n- Line 591: intentional_kw hardcoded list\n- Line 620: budget cats hardcoded list\n- Line 571: Title case enforcement not configurable\n- Line 1015: Hardcoded trip label pattern 'china-feb'",
      "after": "Validation completes successfully with exit code 1 (expected due to existing data issues, not validation code issues). Results:\n- Total items validated: 6004 required fields, 4053 optional fields\n- Required field coverage: 96.7% (5808/6004)\n- Optional field coverage: 94.8% (3843/4053)\n- Issues found: 286 HIGH, 223 MEDIUM, 210 LOW, 248 INFO\n- Verdict: FAIL (due to missing required fields in bucket-list data, not validation logic)\n\nAll 9 hardcoded patterns eliminated:\n✓ Fix 1: english_placeholders now in CONFIG\n✓ Fix 2: currency_region_map disabled (set to {})\n✓ Fix 3: base/local pair logic already schema-driven (no change needed)\n✓ Fix 4: intentional_overlap_keywords now in CONFIG\n✓ Fix 5: budget categories extracted from schema\n✓ Fix 6: title case enforcement now configurable\n✓ Fix 7: transport types extracted from schema (found new 'transit' type)\n✓ Fix 8: AGENTS_WITH_LOCAL inferred from schemas\n✓ Fix 9: trip label hardcoding removed",
      "comparison": "BEFORE: Hardcoded validation logic caused maintenance burden (code changes needed for new regions) and crashes (TypeError on budget validation).\n\nAFTER: Configuration-based validation enables:\n1. Easy customization via CONFIG dict (no code changes)\n2. Schema-driven validation stays in sync with schema updates\n3. Automatic adaptation to new agents/categories\n4. Zero crashes (added type checking for robustness)\n5. Better maintainability (comprehensive documentation)"
    },
    "qa_ready": true,
    "qa_notes": "Run validation on all test data: python scripts/plan-validate.py --min-severity MEDIUM\n\nExpected behavior:\n1. Validation completes without crashes (exit code 0 or 1 depending on data quality)\n2. AGENTS_WITH_LOCAL should equal {meals, attractions, entertainment, accommodation, shopping}\n3. VALID_TRANSPORT_TYPES should include {bus, car, ferry, metro, taxi, train, walk}\n4. Budget categories should equal [meals, accommodation, activities, shopping, transportation]\n5. CONFIG settings should be easily modifiable (test by changing enforce_title_case to False)\n6. No hardcoded city names, currency codes, or keyword lists in validation logic (verified by code inspection)\n7. Validation discovers new transport type 'transit' in timeline data (schema-driven detection working)\n\nRegression tests:\n- Existing validation issues should still be caught (no false negatives)\n- No new false positives introduced by refactoring\n- Performance should be comparable (no significant degradation)",
    "permissions_to_add": []
  }
}
