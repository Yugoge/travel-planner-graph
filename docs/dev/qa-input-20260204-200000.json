{
  "request_id": "dev-20260204-200000",
  "timestamp": "2026-02-04T20:00:00Z",
  "requirement": {
    "original": "系统性修复为什么你不用subagent查询，这是第五次了",
    "clarified": "Fix orchestrator architectural violation: Orchestrator is directly using MCP research tools (gaode-maps, rednote, google-maps) instead of delegating to subagents. This is the 5th occurrence and represents a systemic architecture violation. Need to add explicit prohibition similar to Write/Edit prohibition implemented in dev-20260204-141257.",
    "what": "Add orchestrator prohibition against using research MCP tools directly",
    "why": "Orchestrator violated architecture by using gaode-maps/rednote/google-maps directly for domain research. This bypasses specialist subagents who should perform research using these tools. Similar to Write/Edit prohibition - orchestrator coordinates, subagents execute research.",
    "where": [
      "/root/.claude/CLAUDE.md (Orchestrator Behavior Constraints section)",
      "/root/travel-planner/.claude/commands/plan.md (workflow reminders if needed)"
    ],
    "scope": {
      "included": [
        "Add explicit prohibition: Orchestrator CANNOT use gaode-maps, rednote, google-maps MCP tools",
        "Add to 'Prohibited Tools' section in CLAUDE.md",
        "Update delegation examples to show MCP tools used by subagents only",
        "Add enforcement rule: If orchestrator needs location/POI/review data, delegate to appropriate subagent",
        "List all prohibited research MCP tools explicitly"
      ],
      "excluded": [
        "Not modifying subagent behavior (they should continue using these tools)",
        "Not prohibiting WebSearch (orchestrator may still use for quick fact-checking)",
        "Not changing existing delegation examples (they already show correct pattern)",
        "Not modifying plan.md unless specific workflow reminders needed"
      ]
    },
    "success_criteria": [
      "CLAUDE.md explicitly lists gaode-maps, rednote, google-maps in Prohibited Tools section",
      "CLAUDE.md explains WHY orchestrator cannot use research MCP tools (delegation principle)",
      "Enforcement section includes decision tree: 'Need POI/location data? → Delegate to subagent'",
      "Examples clearly show subagents using MCP tools, orchestrator using Task tool",
      "Documentation prevents future violations of this pattern"
    ],
    "constraints": [
      "Must maintain existing Write/Edit/NotebookEdit prohibitions",
      "Must not break existing delegation examples",
      "Must align with existing orchestrator architecture principles",
      "Keep instructions concise and actionable"
    ]
  },
  "root_cause_analysis": {
    "symptom": "Orchestrator directly used gaode-maps Skill to query restaurant-to-station distance instead of delegating to transportation-agent",
    "root_cause": "No explicit prohibition against orchestrator using research MCP tools (gaode-maps, rednote, google-maps). CLAUDE.md only prohibits Write/Edit/NotebookEdit but doesn't prohibit research tools.",
    "root_cause_evidence": {
      "current_claude_md": "Lines 142-147 list only Write/Edit/NotebookEdit as prohibited. Lines 157-162 list allowed tools but don't explicitly exclude research MCP tools.",
      "examples_show_wrong_pattern": "Line 238 shows WRONG pattern: 'Uses gaode-maps directly' but this is only in example, not in prohibition list",
      "missing_explicit_rule": "No rule saying 'Orchestrator CANNOT use gaode-maps/rednote/google-maps'"
    },
    "why_introduced": "Previous architectural fix (dev-20260204-141257) focused on Write/Edit prohibition for file operations. MCP tool prohibition wasn't considered because focus was on file modification, not research delegation.",
    "why_problematic": "When orchestrator uses research MCP tools directly: (1) Bypasses specialist subagent expertise, (2) Violates coordination vs execution separation, (3) Results may lack domain context that specialist would apply, (4) Creates inconsistent architecture (sometimes delegate, sometimes do directly)",
    "timeline": "Violation occurred during Day 3 review when orchestrator used gaode-maps Skill directly to calculate restaurant-to-station distance instead of delegating to transportation-agent",
    "affected_files": [
      "/root/.claude/CLAUDE.md (missing prohibition)",
      "Conversation history (5 instances of direct MCP tool usage)"
    ]
  },
  "context": {
    "codebase_state": "4 uncommitted files, working on master branch",
    "recent_commits": [
      "d87204a - checkpoint: Auto-save at 2026-02-04 14:16:16",
      "41f1017 - checkpoint: Auto-save at 2026-02-04 12:31:18"
    ],
    "current_architecture": {
      "orchestrator_role": "Coordinate subagents, present information, NEVER directly execute research or modifications",
      "subagent_role": "Execute specialized tasks including domain research using MCP tools",
      "prohibited_tools_current": [
        "Write",
        "Edit",
        "NotebookEdit"
      ],
      "prohibited_tools_needed": [
        "Write",
        "Edit",
        "NotebookEdit",
        "gaode-maps",
        "rednote",
        "google-maps",
        "plus any MCP research tools"
      ],
      "allowed_tools": [
        "Read",
        "Task",
        "TodoWrite",
        "Bash",
        "Skill",
        "WebSearch (for quick facts only)"
      ]
    },
    "file_contents": {
      "claude_md_lines_138_163": "Current Orchestrator Behavior Constraints section with Write/Edit/NotebookEdit prohibitions and allowed tools list",
      "claude_md_lines_188_270": "Delegation examples showing correct pattern (subagents use gaode-maps, orchestrator uses Task tool) but prohibition not in main rules section"
    },
    "research_mcp_tools": {
      "gaode_maps": "Chinese maps, POI search, routing - used by transportation/meals/attractions/accommodation/shopping agents",
      "rednote": "Xiaohongshu reviews - used by meals/entertainment/shopping agents",
      "google_maps": "International maps, POI search - used by same agents for non-China locations"
    }
  },
  "development_approach": {
    "strategy": "Add MCP research tools to Prohibited Tools section in CLAUDE.md. Mirror the Write/Edit prohibition pattern: explicit prohibition + explanation of why + enforcement decision tree. Update allowed tools section to clarify WebSearch is allowed for quick facts but domain research must be delegated.",
    "implementation_steps": [
      "1. Read current CLAUDE.md Orchestrator Behavior Constraints section (lines 138-310)",
      "2. Add gaode-maps, rednote, google-maps to Prohibited Tools list (after NotebookEdit)",
      "3. Add explanation: 'Orchestrator NEVER uses research MCP tools - domain research is delegated to specialists'",
      "4. Update 'Why This Restriction Exists' to include research delegation principle",
      "5. Update 'Orchestrator CAN Use These Tools' to clarify WebSearch usage (quick facts only, not domain research)",
      "6. Add to Enforcement section: Decision tree for 'Need POI/location/review data? → Delegate to appropriate subagent'",
      "7. Verify delegation examples (lines 188-270) already show correct pattern",
      "8. Test: Read updated section and verify all research MCP tools explicitly prohibited"
    ],
    "files_to_modify": [
      "/root/.claude/CLAUDE.md (Orchestrator Behavior Constraints section, lines 138-310)"
    ],
    "validation_approach": "QA will verify: (1) gaode-maps/rednote/google-maps explicitly in Prohibited Tools, (2) Explanation of why research must be delegated, (3) Enforcement decision tree includes research delegation, (4) Examples remain correct, (5) No regression in Write/Edit prohibitions"
  },
  "standards_to_enforce": {
    "no_hardcoded_values": "N/A (documentation only)",
    "use_source_venv": "N/A (documentation only)",
    "integer_step_numbering": true,
    "meaningful_naming": true,
    "git_root_cause_reference": true,
    "clear_architectural_boundaries": "Orchestrator vs subagent research responsibilities must be crystal clear",
    "actionable_examples": "Existing examples already show correct pattern, no new examples needed"
  },
  "dev": {
    "status": "completed",
    "tasks_completed": [
      {
        "id": 1,
        "description": "Added gaode-maps, rednote, google-maps to Prohibited Tools section",
        "type": "documentation",
        "files_modified": [
          "/root/.claude/CLAUDE.md"
        ],
        "changes": "Added three MCP research tools to lines 148-150: gaode-maps (POI/location research), rednote (review research), google-maps (POI/location research). These tools are now explicitly prohibited for orchestrator use, mirroring the Write/Edit prohibition pattern.",
        "rationale": "Root cause was lack of explicit prohibition against orchestrator using research MCP tools. This change makes research tool prohibition as clear as file modification prohibition, preventing orchestrator from bypassing subagent domain expertise."
      },
      {
        "id": 2,
        "description": "Updated 'Why This Restriction Exists' section to include research delegation principle",
        "type": "documentation",
        "files_modified": [
          "/root/.claude/CLAUDE.md"
        ],
        "changes": "Added point 5 to line 157: 'Research Delegation: Domain research (POI, reviews, routing) requires specialist context that orchestrator lacks. Subagents apply constraints (budget, dietary, accessibility) when researching.'",
        "rationale": "Explains WHY orchestrator cannot use research MCP tools - not just prohibition but reasoning. Subagents have domain context (budget, dietary requirements, accessibility) that orchestrator lacks when performing research."
      },
      {
        "id": 3,
        "description": "Clarified WebSearch usage in allowed tools section",
        "type": "documentation",
        "files_modified": [
          "/root/.claude/CLAUDE.md"
        ],
        "changes": "Added to line 167: 'WebSearch: Quick fact-checking only (e.g., \"What year did X open?\"). NOT for domain research - delegate POI/review/routing research to subagents who use gaode-maps/rednote/google-maps.'",
        "rationale": "Prevents confusion about when orchestrator can use search tools. WebSearch allowed for simple facts, but domain research (POI, reviews, routing) must be delegated to subagents who use specialized MCP tools with domain constraints."
      },
      {
        "id": 4,
        "description": "Added research delegation decision tree to Enforcement section",
        "type": "documentation",
        "files_modified": [
          "/root/.claude/CLAUDE.md"
        ],
        "changes": "Added new enforcement rule at lines 317-322: Step-by-step decision tree for when orchestrator needs POI/location/review/routing data. Steps: STOP → Identify specialist subagent → Use Task tool → Wait for subagent to research using MCP tools → Read updated working file.",
        "rationale": "Provides actionable enforcement mechanism. When orchestrator needs research data, clear steps prevent direct MCP tool usage and ensure delegation to appropriate specialist subagent."
      },
      {
        "id": 5,
        "description": "Updated final enforcement warning to include research",
        "type": "documentation",
        "files_modified": [
          "/root/.claude/CLAUDE.md"
        ],
        "changes": "Modified line 324 from 'Never rationalize direct file modification' to 'Never rationalize direct file modification or direct research'. Makes it clear both file operations AND research operations must be delegated.",
        "rationale": "Ensures orchestrator cannot justify direct research as 'faster' or 'simpler' just as it cannot justify direct file modification. Reinforces architectural principle uniformly."
      },
      {
        "id": 6,
        "description": "Verified delegation examples remain correct",
        "type": "validation",
        "files_modified": [],
        "changes": "Read lines 193-276 to verify Examples 1 and 2 already demonstrate correct pattern: subagents use gaode-maps/rednote for research, orchestrator uses Task tool for delegation. No changes needed.",
        "rationale": "Existing examples already show correct architecture - subagents perform research using MCP tools while orchestrator coordinates via Task tool. Examples support new prohibitions without modification."
      }
    ],
    "files_modified": [
      "/root/.claude/CLAUDE.md"
    ],
    "git_rationale": {
      "root_cause": "No explicit prohibition against orchestrator using research MCP tools (gaode-maps, rednote, google-maps). CLAUDE.md only prohibited Write/Edit/NotebookEdit but didn't prohibit research tools.",
      "root_cause_commit": "Previous architectural fix (dev-20260204-141257) focused only on file modification prohibition",
      "why_issue_occurred": "When previous fix added Write/Edit prohibition, focus was on file operations. Research delegation principle wasn't explicitly documented as prohibited tool usage. Orchestrator used gaode-maps directly during Day 3 review instead of delegating to transportation-agent because no explicit rule prevented it.",
      "how_fix_addresses_root": "Adds explicit MCP research tool prohibition mirroring Write/Edit pattern. Makes research delegation as clear as file modification delegation. Provides enforcement decision tree so orchestrator knows to delegate research to subagents. Clarifies WebSearch boundary (facts only, not domain research)."
    },
    "qa_ready": true,
    "qa_notes": "Verify: (1) gaode-maps, rednote, google-maps explicitly listed in Prohibited Tools section (lines 148-150), (2) Research delegation explanation in 'Why This Restriction Exists' (line 157), (3) WebSearch clarification in Allowed Tools (line 167), (4) Research delegation decision tree in Enforcement (lines 317-322), (5) Updated enforcement warning includes 'or direct research' (line 324), (6) Existing delegation examples (lines 193-276) still show correct pattern - no regression in Write/Edit prohibitions",
    "blocking_issues": [],
    "permissions_to_add": []
  }
}
