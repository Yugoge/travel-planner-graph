{
  "request_id": "dev-agent-fixes-20260213-163000",
  "timestamp": "2026-02-13T16:30:00Z",
  "requirement": {
    "original": "立即将完整的context给一个dev修复 - Fix all issues found by 8 agent self-debug",
    "clarified": "Fix all CRITICAL and HIGH severity issues discovered during agent self-debug, including timeline data schema conflicts, meals validation errors, and documentation issues",
    "what": "Fix multiple critical issues across timeline.json data and agent documentation",
    "why": "Agent self-debug revealed critical data integrity issues and documentation problems that cause agents to fail",
    "where": [
      "data/china-feb-15-mar-7-2026-20260202-195429/timeline.json",
      "data/china-feb-15-mar-7-2026-20260202-195429/meals.json",
      ".claude/agents/timeline.md",
      ".claude/agents/transportation.md",
      "schemas/poi-common.schema.json"
    ],
    "scope": {
      "included": [
        "Remove legacy 'mode' field from timeline.json travel_segments",
        "Fix or remove image_url fields from meals.json",
        "Remove reference to non-existent save-agent-data-template.py",
        "Add duration conversion validation documentation",
        "Fix all CRITICAL and HIGH severity issues"
      ],
      "excluded": [
        "MEDIUM and LOW severity issues (defer to later)",
        "Complete schema redesign",
        "Rewriting entire agent workflows"
      ]
    },
    "success_criteria": [
      "timeline.json validation passes (no HIGH severity errors)",
      "meals.json validation passes (no HIGH severity errors)",
      "No references to non-existent files in agent docs",
      "All travel_segments use type_base/type_local/icon only (no mode field)",
      "plan-validate.py returns exit code 0 for timeline and meals agents"
    ],
    "constraints": [
      "Must preserve all functional data (don't delete actual content)",
      "Must maintain backward compatibility where possible",
      "Must not break existing workflows"
    ]
  },
  "root_cause_analysis": {
    "symptom": "Agent self-debug revealed 51 total validation failures and documentation issues",
    "root_causes": [
      {
        "issue": "Timeline travel_segments have legacy 'mode' field",
        "root_cause": "Schema was updated to use type_base/type_local/icon but existing data not migrated",
        "affected": "12 travel segments in timeline.json (Day 2, Day 4)",
        "severity": "HIGH"
      },
      {
        "issue": "Meals.json contains image_url fields rejected by schema",
        "root_cause": "Image URLs were added to data but schema doesn't allow them",
        "affected": "3 meal POIs in meals.json",
        "severity": "HIGH"
      },
      {
        "issue": "Timeline.md references non-existent save-agent-data-template.py",
        "root_cause": "Documentation not updated when file was removed/renamed",
        "affected": "timeline.md documentation",
        "severity": "HIGH"
      },
      {
        "issue": "No validation for duration unit conversion (seconds vs minutes)",
        "root_cause": "Gaode Maps returns seconds, easy to forget conversion causing 60x errors",
        "affected": "transportation agent workflow",
        "severity": "MEDIUM (design issue)"
      }
    ],
    "timeline": "Issues accumulated over multiple development cycles",
    "affected_files": [
      "data/china-feb-15-mar-7-2026-20260202-195429/timeline.json",
      "data/china-feb-15-mar-7-2026-20260202-195429/meals.json",
      ".claude/agents/timeline.md",
      ".claude/agents/transportation.md"
    ]
  },
  "context": {
    "agent_debug_reports": {
      "timeline": "docs/dev/timeline-agent-debug-20260213.json (23K, 12 HIGH issues)",
      "meals": "docs/dev/meals-agent-debug-20260213.json (6.5K, 3 HIGH issues)",
      "transportation": "docs/dev/transportation-agent-debug-20260213.json (14K, design recommendations)",
      "attractions": "docs/dev/attractions-agent-debug-20260213.json (12K)",
      "all_summary": "docs/dev/all-agents-debug-summary-20260213.md"
    },
    "validation_failures": {
      "timeline": {
        "high_severity": 12,
        "medium_severity": 15,
        "low_severity": 24,
        "main_issue": "travel_segments contain both 'mode' (legacy) and 'type_base' (new) fields"
      },
      "meals": {
        "high_severity": 3,
        "issue": "image_url fields forbidden by schema but present in data"
      }
    },
    "test_trip": "china-feb-15-mar-7-2026-20260202-195429",
    "codebase_state": "21-day complete timeline restored from commit dad5f19",
    "environment": {
      "venv_path": "venv/",
      "python_version": "3.x",
      "validation_script": "scripts/plan-validate.py"
    }
  },
  "development_approach": {
    "strategy": "Fix data schema issues first, then documentation issues",
    "tasks": [
      {
        "task_id": "1",
        "priority": "CRITICAL",
        "description": "Remove legacy 'mode' field from all travel_segments in timeline.json",
        "approach": "Read timeline.json, iterate through all days, remove 'mode' field from travel_segments arrays, keep type_base/type_local/icon",
        "validation": "python3 scripts/plan-validate.py TRIP --agent timeline (exit code 0)"
      },
      {
        "task_id": "2",
        "priority": "HIGH",
        "description": "Fix image_url fields in meals.json",
        "approach": "Option 1 (preferred): Add image_url to poi-common.schema.json as optional field. Option 2: Remove image_url from 3 meal POIs",
        "validation": "python3 scripts/plan-validate.py TRIP --agent meals (exit code 0)"
      },
      {
        "task_id": "3",
        "priority": "HIGH",
        "description": "Remove reference to non-existent save-agent-data-template.py from timeline.md",
        "approach": "Find and remove the line referencing this file, or replace with correct reference",
        "validation": "grep -r 'save-agent-data-template.py' .claude/agents/ returns nothing"
      },
      {
        "task_id": "4",
        "priority": "MEDIUM",
        "description": "Add documentation about duration conversion in transportation.md",
        "approach": "Add clear warning: 'CRITICAL: Gaode Maps returns SECONDS. Must divide by 60 for minutes.'",
        "validation": "Documentation contains explicit conversion warning"
      }
    ],
    "scripts_to_create": [
      "None - direct file edits sufficient for this fix"
    ],
    "files_to_modify": [
      "data/china-feb-15-mar-7-2026-20260202-195429/timeline.json",
      "data/china-feb-15-mar-7-2026-20260202-195429/meals.json (or schemas/poi-common.schema.json)",
      ".claude/agents/timeline.md",
      ".claude/agents/transportation.md"
    ],
    "validation_approach": "Run plan-validate.py for timeline and meals agents, verify exit code 0, check grep for removed references"
  },
  "standards_to_enforce": {
    "no_hardcoded_values": true,
    "use_source_venv": true,
    "preserve_data_integrity": true,
    "validate_after_changes": true,
    "git_root_cause_reference": true
  }
}
